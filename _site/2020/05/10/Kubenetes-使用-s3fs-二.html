<!DOCTYPE html>
<html>

  <head>
  <title>Kubernetes 实战四：Kubernetes 使用 s3fs （二）</title>
  <!-- link to main stylesheet -->
  <link rel="stylesheet" type="text/css" href="/assets/css/main.css">
  <link rel="stylesheet" type="text/css" href="/assets/css/font-awesome-4.6.1/css/font-awesome.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</head>


  <body>
    <article class="content">
      <h1 class="post-title">Kubernetes 实战四：Kubernetes 使用 s3fs （二）</h1>
      <p>
        
        
        
      </p>

      <div id="outline-container-orgbb061e0" class="outline-2">
<h2 id="orgbb061e0"><span class="section-number-2">1</span> 背景</h2>
<div class="outline-text-2" id="text-1">
<p>
上一个博客介绍了通过 daemontset 挂载 s3fs 的过程，当时还考虑过另外一个方法，通过写一个 csi plugin 的方式挂载 s3fs。这篇文章记录下这个过程。
</p>
</div>
</div>

<div id="outline-container-org224dbec" class="outline-2">
<h2 id="org224dbec"><span class="section-number-2">2</span> 认识 CSI Driver</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org8f99851" class="outline-3">
<h3 id="org8f99851"><span class="section-number-3">2.1</span> CSI Driver 的作用</h3>
<div class="outline-text-3" id="text-2-1">
<p>
CSI（Container Storage Interface）是把块存储或者文件存储暴露给 k8s 的标准，CSI Driver 是对这个标准的实现。CSI driver 的作用是让 k8s 可以使用我们的存储，创建或者修改对应的 volume，实现诸如 create/resize/snapshot/backup volume 等功能。
</p>
</div>
</div>

<div id="outline-container-org0863315" class="outline-3">
<h3 id="org0863315"><span class="section-number-3">2.2</span> CSI Driver 与 k8s 的交互</h3>
<div class="outline-text-3" id="text-2-2">
<p>
交互有两个方向：
</p>
<ul class="org-ul">
<li>k8s -&gt; csi driver: 通过 unix domain socket，kubelet 发送 rpc 请求。csi driver 需要先把自己注册给 kubelet</li>
<li>csi driver -&gt; k8s: 通过 k8s api</li>
</ul>
</div>
</div>

<div id="outline-container-org588ac49" class="outline-3">
<h3 id="org588ac49"><span class="section-number-3">2.3</span> 如何开发一个 CSI Driver</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>创建容器化的应用，实现 Identity, Node, Controller service</li>
<li>使用 csi-sanity 进行单元测试</li>
<li>准备部署需要的 yaml 文件</li>
<li>部署应用到 k8s 集群，端到端测试</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org7d32d58" class="outline-2">
<h2 id="org7d32d58"><span class="section-number-2">3</span> 动手创建一个 CSI Driver</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org976ac13" class="outline-3">
<h3 id="org976ac13"><span class="section-number-3">3.1</span> 创建 identityserver</h3>
<div class="outline-text-3" id="text-3-1">
<p>
identityserver 的作用是提供提供插件的自说明信息，如插件的名称和版本以及支持的功能集合；提供接口判断插件是否运行；
</p>

<p>
identityserver.go
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900;">package</span> s3fs

<span style="color: #859900;">import</span> (
        <span style="color: #2aa198;">"github.com/container-storage-interface/spec/lib/go/csi"</span>
        <span style="color: #2aa198;">"github.com/golang/glog"</span>
        <span style="color: #2aa198;">"github.com/golang/protobuf/ptypes/wrappers"</span>
        <span style="color: #2aa198;">"golang.org/x/net/context"</span>
        <span style="color: #2aa198;">"google.golang.org/grpc/codes"</span>
        <span style="color: #2aa198;">"google.golang.org/grpc/status"</span>
)

<span style="color: #859900;">type</span> <span style="color: #268bd2;">IdentityServer</span> <span style="color: #859900;">struct</span> {
        Driver *Driver
}

<span style="color: #859900;">func</span> (ids *<span style="color: #268bd2;">IdentityServer</span>) <span style="color: #b58900;">GetPluginInfo</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.GetPluginInfoRequest</span>) (*<span style="color: #268bd2;">csi.GetPluginInfoResponse</span>, <span style="color: #268bd2;">error</span>) {
        glog.<span style="color: #b58900;">V</span>(5).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"Using default GetPluginInfo"</span>)

        <span style="color: #859900;">if</span> ids.Driver.name == <span style="color: #2aa198;">""</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unavailable, <span style="color: #2aa198;">"Driver name not configured"</span>)
        }

        <span style="color: #859900;">if</span> ids.Driver.version == <span style="color: #2aa198;">""</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unavailable, <span style="color: #2aa198;">"Driver is missing version"</span>)
        }

        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">GetPluginInfoResponse</span>{
                <span style="color: #268bd2;">Name</span>:          ids.Driver.name,
                <span style="color: #268bd2;">VendorVersion</span>: ids.Driver.version,
        }, <span style="color: #268bd2;">nil</span>
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Probe check whether the plugin is running or not.</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">This method does not need to return anything.</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Currently the spec does not dictate what you should return either.</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Hence, return an empty response</span>
<span style="color: #859900;">func</span> (ids *<span style="color: #268bd2;">IdentityServer</span>) <span style="color: #b58900;">Probe</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ProbeRequest</span>) (*<span style="color: #268bd2;">csi.ProbeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">ProbeResponse</span>{Ready: &amp;wrappers.<span style="color: #268bd2;">BoolValue</span>{Value: <span style="color: #268bd2;">true</span>}}, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (ids *<span style="color: #268bd2;">IdentityServer</span>) <span style="color: #b58900;">GetPluginCapabilities</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.GetPluginCapabilitiesRequest</span>) (*<span style="color: #268bd2;">csi.GetPluginCapabilitiesResponse</span>, <span style="color: #268bd2;">error</span>) {
        glog.<span style="color: #b58900;">V</span>(5).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"Using default capabilities"</span>)
        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">GetPluginCapabilitiesResponse</span>{
                <span style="color: #268bd2;">Capabilities</span>: []*<span style="color: #268bd2;">csi.PluginCapability</span>{
                        {
                                <span style="color: #268bd2;">Type</span>: &amp;csi.<span style="color: #268bd2;">PluginCapability_Service_</span>{
                                        <span style="color: #268bd2;">Service</span>: &amp;csi.<span style="color: #268bd2;">PluginCapability_Service</span>{
                                                <span style="color: #268bd2;">Type</span>: csi.PluginCapability_Service_CONTROLLER_SERVICE,
                                        },
                                },
                        },
                },
        }, <span style="color: #268bd2;">nil</span>
}

</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4d1bda" class="outline-3">
<h3 id="orgb4d1bda"><span class="section-number-3">3.2</span> 创建 controllerserver</h3>
<div class="outline-text-3" id="text-3-2">
<p>
controllerserver 是控制的入口，接收请求，完成创建、删除、挂载、卸载 volume 的功能。
</p>

<p>
controllerserver 的实现如下：
</p>

<p>
controllerserver.go
</p>
<div class="org-src-container">
<pre class="src src-go">
<span style="color: #859900;">package</span> s3fs

<span style="color: #859900;">import</span> (
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"os"</span>
        <span style="color: #2aa198;">"path/filepath"</span>
        <span style="color: #2aa198;">"strings"</span>

        <span style="color: #2aa198;">"github.com/container-storage-interface/spec/lib/go/csi"</span>
        <span style="color: #2aa198;">"github.com/golang/glog"</span>
        <span style="color: #2aa198;">"golang.org/x/net/context"</span>
        <span style="color: #2aa198;">"google.golang.org/grpc/codes"</span>
        <span style="color: #2aa198;">"google.golang.org/grpc/status"</span>
)

<span style="color: #859900;">type</span> <span style="color: #268bd2;">ControllerServer</span> <span style="color: #859900;">struct</span> {
        Driver *Driver
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Working directory for the provisioner to temporarily mount s3fs shares at</span>
        workingMountDir string
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">s3fsVolume is an internal representation of a volume</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">created by the provisioner.</span>
<span style="color: #859900;">type</span> <span style="color: #268bd2;">s3fsVolume</span> <span style="color: #859900;">struct</span> {
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Volume id</span>
        id string
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Address of the s3fs server.</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Matches paramServer.</span>
        server string
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">s3 bucketName</span>
        bucket string

        baseDir string

        subDir string
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">size of volume</span>
        size int64
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Ordering of elements in the CSI volume id.</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">ID is of the form {server}/{baseDir}/{subDir}.</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">TODO: This volume id format limits baseDir and</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">subDir to only be one directory deep.</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Adding a new element should always go at the end</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">before totalIDElements</span>
<span style="color: #859900;">const</span> (
        idServer = <span style="color: #268bd2;">iota</span>
        idBucket
        idBaseDir
        idSubDir
        totalIDElements <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Always last</span>
)

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">CreateVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.CreateVolumeRequest</span>) (*<span style="color: #268bd2;">csi.CreateVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Validate arguments</span>
        name := req.<span style="color: #b58900;">GetName</span>()
        <span style="color: #859900;">if</span> <span style="color: #6c71c4;">len</span>(name) == 0 {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"CreateVolume name must be provided"</span>)
        }

        <span style="color: #859900;">if</span> err := cs.<span style="color: #b58900;">validateVolumeCapabilities</span>(req.<span style="color: #b58900;">GetVolumeCapabilities</span>()); err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, err.<span style="color: #b58900;">Error</span>())
        }

        reqCapacity := req.<span style="color: #b58900;">GetCapacityRange</span>().<span style="color: #b58900;">GetRequiredBytes</span>()
        s3fsVol, err := cs.<span style="color: #b58900;">newS3FSVolume</span>(name, reqCapacity, req.<span style="color: #b58900;">GetParameters</span>())
        <span style="color: #859900;">if</span> err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, err.<span style="color: #b58900;">Error</span>())
        }

        <span style="color: #859900;">if</span> err = cs.<span style="color: #b58900;">internalMount</span>(ctx, s3fsVol); err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Errorf</span>(codes.Internal, <span style="color: #2aa198;">"failed to mount s3fs server: %v"</span>, err.<span style="color: #b58900;">Error</span>())
        }
        <span style="color: #859900;">defer</span> <span style="color: #859900;">func</span>() {
                <span style="color: #859900;">if</span> err = cs.<span style="color: #b58900;">internalUnmount</span>(ctx, s3fsVol); err != <span style="color: #268bd2;">nil</span> {
                        glog.<span style="color: #b58900;">Warningf</span>(<span style="color: #2aa198;">"failed to unmount s3fs server: %v"</span>, err.<span style="color: #b58900;">Error</span>())
                }
        }()

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Create subdirectory under base-dir</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">TODO: revisit permissions</span>
        internalVolumePath := cs.<span style="color: #b58900;">getInternalVolumePath</span>(s3fsVol)
        <span style="color: #859900;">if</span> err = os.<span style="color: #b58900;">Mkdir</span>(internalVolumePath, 0777); err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Errorf</span>(codes.Internal, <span style="color: #2aa198;">"failed to make subdirectory: %v"</span>, err.<span style="color: #b58900;">Error</span>())
        }
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Remove capacity setting when provisioner 1.4.0 is available with fix for</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">https://github.com/kubernetes-csi/external-provisioner/pull/271</span>
        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">CreateVolumeResponse</span>{Volume: cs.<span style="color: #b58900;">s3fsVolToCSI</span>(s3fsVol, reqCapacity)}, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">DeleteVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.DeleteVolumeRequest</span>) (*<span style="color: #268bd2;">csi.DeleteVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        volumeID := req.<span style="color: #b58900;">GetVolumeId</span>()
        <span style="color: #859900;">if</span> volumeID == <span style="color: #2aa198;">""</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"volume id is empty"</span>)
        }
        s3fsVol, err := cs.<span style="color: #b58900;">getS3fsVolFromID</span>(volumeID)
        <span style="color: #859900;">if</span> err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">An invalid ID should be treated as doesn't exist</span>
                glog.<span style="color: #b58900;">V</span>(5).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"failed to get s3fs volume for volume id %v deletion: %v"</span>, volumeID, err)
                <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">DeleteVolumeResponse</span>{}, <span style="color: #268bd2;">nil</span>
        }

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Mount s3fs base share so we can delete the subdirectory</span>
        <span style="color: #859900;">if</span> err = cs.<span style="color: #b58900;">internalMount</span>(ctx, s3fsVol); err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Errorf</span>(codes.Internal, <span style="color: #2aa198;">"failed to mount s3fs server: %v"</span>, err.<span style="color: #b58900;">Error</span>())
        }
        <span style="color: #859900;">defer</span> <span style="color: #859900;">func</span>() {
                <span style="color: #859900;">if</span> err = cs.<span style="color: #b58900;">internalUnmount</span>(ctx, s3fsVol); err != <span style="color: #268bd2;">nil</span> {
                        glog.<span style="color: #b58900;">Warningf</span>(<span style="color: #2aa198;">"failed to unmount s3fs server: %v"</span>, err.<span style="color: #b58900;">Error</span>())
                }
        }()

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Delete subdirectory under base-dir</span>
        internalVolumePath := cs.<span style="color: #b58900;">getInternalVolumePath</span>(s3fsVol)

        glog.<span style="color: #b58900;">V</span>(4).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"Removing subdirectory at %v"</span>, internalVolumePath)
        <span style="color: #859900;">if</span> err = os.<span style="color: #b58900;">RemoveAll</span>(internalVolumePath); err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Errorf</span>(codes.Internal, <span style="color: #2aa198;">"failed to delete subdirectory: %v"</span>, err.<span style="color: #b58900;">Error</span>())
        }

        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">DeleteVolumeResponse</span>{}, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">ControllerPublishVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ControllerPublishVolumeRequest</span>) (*<span style="color: #268bd2;">csi.ControllerPublishVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">ControllerUnpublishVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ControllerUnpublishVolumeRequest</span>) (*<span style="color: #268bd2;">csi.ControllerUnpublishVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">ControllerGetVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ControllerGetVolumeRequest</span>) (*<span style="color: #268bd2;">csi.ControllerGetVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">ValidateVolumeCapabilities</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ValidateVolumeCapabilitiesRequest</span>) (*<span style="color: #268bd2;">csi.ValidateVolumeCapabilitiesResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">if</span> <span style="color: #6c71c4;">len</span>(req.<span style="color: #b58900;">GetVolumeId</span>()) == 0 {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"Volume ID missing in request"</span>)
        }
        <span style="color: #859900;">if</span> req.<span style="color: #b58900;">GetVolumeCapabilities</span>() == <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"Volume capabilities missing in request"</span>)
        }

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">supports all AccessModes, no need to check capabilities here</span>
        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">ValidateVolumeCapabilitiesResponse</span>{Message: <span style="color: #2aa198;">""</span>}, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">ListVolumes</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ListVolumesRequest</span>) (*<span style="color: #268bd2;">csi.ListVolumesResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">GetCapacity</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.GetCapacityRequest</span>) (*<span style="color: #268bd2;">csi.GetCapacityResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">ControllerGetCapabilities implements the default GRPC callout.</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Default supports all capabilities</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">ControllerGetCapabilities</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ControllerGetCapabilitiesRequest</span>) (*<span style="color: #268bd2;">csi.ControllerGetCapabilitiesResponse</span>, <span style="color: #268bd2;">error</span>) {
        glog.<span style="color: #b58900;">V</span>(5).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"Using default ControllerGetCapabilities"</span>)

        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">ControllerGetCapabilitiesResponse</span>{
                <span style="color: #268bd2;">Capabilities</span>: cs.Driver.cscap,
        }, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">CreateSnapshot</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.CreateSnapshotRequest</span>) (*<span style="color: #268bd2;">csi.CreateSnapshotResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">DeleteSnapshot</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.DeleteSnapshotRequest</span>) (*<span style="color: #268bd2;">csi.DeleteSnapshotResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">ListSnapshots</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ListSnapshotsRequest</span>) (*<span style="color: #268bd2;">csi.ListSnapshotsResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">ControllerExpandVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.ControllerExpandVolumeRequest</span>) (*<span style="color: #268bd2;">csi.ControllerExpandVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">validateVolumeCapabilities</span>(caps []*<span style="color: #268bd2;">csi.VolumeCapability</span>) <span style="color: #268bd2;">error</span> {
        <span style="color: #859900;">if</span> <span style="color: #6c71c4;">len</span>(caps) == 0 {
                <span style="color: #859900;">return</span> fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"volume capabilities must be provided"</span>)
        }

        <span style="color: #859900;">for</span> _, c := <span style="color: #859900;">range</span> caps {
                <span style="color: #859900;">if</span> err := cs.<span style="color: #b58900;">validateVolumeCapability</span>(c); err != <span style="color: #268bd2;">nil</span> {
                        <span style="color: #859900;">return</span> err
                }
        }
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">validateVolumeCapability</span>(c *<span style="color: #268bd2;">csi.VolumeCapability</span>) <span style="color: #268bd2;">error</span> {
        <span style="color: #859900;">if</span> c == <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"volume capability must be provided"</span>)
        }

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Validate access mode</span>
        accessMode := c.<span style="color: #b58900;">GetAccessMode</span>()
        <span style="color: #859900;">if</span> accessMode == <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"volume capability access mode not set"</span>)
        }
        <span style="color: #859900;">if</span> !cs.Driver.cap[accessMode.Mode] {
                <span style="color: #859900;">return</span> fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"driver does not support access mode: %v"</span>, accessMode.Mode.<span style="color: #b58900;">String</span>())
        }

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Validate access type</span>
        accessType := c.<span style="color: #b58900;">GetAccessType</span>()
        <span style="color: #859900;">if</span> accessType == <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"volume capability access type not set"</span>)
        }
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Mount s3fs server at base-dir</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">internalMount</span>(ctx <span style="color: #268bd2;">context.Context</span>, vol *<span style="color: #268bd2;">s3fsVolume</span>) <span style="color: #268bd2;">error</span> {
        sharePath := filepath.<span style="color: #b58900;">Join</span>(<span style="color: #b58900;">string</span>(filepath.Separator) + vol.baseDir)
        targetPath := cs.<span style="color: #b58900;">getInternalMountPath</span>(vol)
        stdVolCap := csi.<span style="color: #268bd2;">VolumeCapability</span>{
                <span style="color: #268bd2;">AccessType</span>: &amp;csi.<span style="color: #268bd2;">VolumeCapability_Mount</span>{
                        <span style="color: #268bd2;">Mount</span>: &amp;csi.<span style="color: #268bd2;">VolumeCapability_MountVolume</span>{},
                },
        }

        glog.<span style="color: #b58900;">V</span>(4).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"internally mounting %v:%v at %v"</span>, vol.server, vol.bucket, targetPath)
        _, err := cs.Driver.ns.<span style="color: #b58900;">NodePublishVolume</span>(ctx, &amp;csi.<span style="color: #268bd2;">NodePublishVolumeRequest</span>{
                <span style="color: #268bd2;">TargetPath</span>: targetPath,
                <span style="color: #268bd2;">VolumeContext</span>: <span style="color: #859900;">map</span>[<span style="color: #268bd2;">string</span>]<span style="color: #268bd2;">string</span>{
                        <span style="color: #268bd2;">paramServer</span>: vol.server,
                        <span style="color: #268bd2;">paramBucket</span>: vol.bucket,
                        <span style="color: #268bd2;">paramShare</span>:  sharePath,
                },
                <span style="color: #268bd2;">VolumeCapability</span>: &amp;stdVolCap,
                <span style="color: #268bd2;">VolumeId</span>:         vol.id,
        })
        <span style="color: #859900;">return</span> err
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Unmount s3fs server at base-dir</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">internalUnmount</span>(ctx <span style="color: #268bd2;">context.Context</span>, vol *<span style="color: #268bd2;">s3fsVolume</span>) <span style="color: #268bd2;">error</span> {
        targetPath := cs.<span style="color: #b58900;">getInternalMountPath</span>(vol)

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Unmount s3fs server at base-dir</span>
        glog.<span style="color: #b58900;">V</span>(4).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"internally unmounting %v"</span>, targetPath)
        _, err := cs.Driver.ns.<span style="color: #b58900;">NodeUnpublishVolume</span>(ctx, &amp;csi.<span style="color: #268bd2;">NodeUnpublishVolumeRequest</span>{
                <span style="color: #268bd2;">VolumeId</span>:   vol.id,
                <span style="color: #268bd2;">TargetPath</span>: cs.<span style="color: #b58900;">getInternalMountPath</span>(vol),
        })
        <span style="color: #859900;">return</span> err
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Convert VolumeCreate parameters to an s3fsVolume</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">newS3FSVolume</span>(name <span style="color: #268bd2;">string</span>, size <span style="color: #268bd2;">int64</span>, params <span style="color: #859900;">map</span>[<span style="color: #268bd2;">string</span>]<span style="color: #268bd2;">string</span>) (*<span style="color: #268bd2;">s3fsVolume</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">var</span> (
                server  string
                baseDir string
                bucket  string
        )

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Validate parameters (case-insensitive).</span>
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">TODO do more strict validation.</span>
        <span style="color: #859900;">for</span> k, v := <span style="color: #859900;">range</span> params {
                <span style="color: #859900;">switch</span> strings.<span style="color: #b58900;">ToLower</span>(k) {
                <span style="color: #859900;">case</span> paramServer:
                        server = v
                <span style="color: #859900;">case</span> paramShare:
                        baseDir = v
                <span style="color: #859900;">case</span> paramBucket:
                        bucket = v
                <span style="color: #859900;">default</span>:
                        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"invalid parameter %q"</span>, k, <span style="color: #2aa198;">"expecting, %v, %v"</span>, paramServer, paramBucket)
                }
        }

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Validate required parameters</span>
        <span style="color: #859900;">if</span> server == <span style="color: #2aa198;">""</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"%v is a required parameter"</span>, paramServer)
        }
        <span style="color: #859900;">if</span> baseDir == <span style="color: #2aa198;">""</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"%v is a required parameter"</span>, paramShare)
        }
        <span style="color: #859900;">if</span> bucket == <span style="color: #2aa198;">""</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"%v is a required parameter"</span>, paramBucket)
        }

        vol := &amp;<span style="color: #268bd2;">s3fsVolume</span>{
                <span style="color: #268bd2;">server</span>:  server,
                <span style="color: #268bd2;">baseDir</span>: baseDir,
                <span style="color: #268bd2;">subDir</span>:  name,
                <span style="color: #268bd2;">bucket</span>:  bucket,
                <span style="color: #268bd2;">size</span>:    size,
        }
        vol.id = cs.<span style="color: #b58900;">getVolumeIDFromS3fsVol</span>(vol)

        <span style="color: #859900;">return</span> vol, <span style="color: #268bd2;">nil</span>
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Get working directory for CreateVolume and DeleteVolume</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">getInternalMountPath</span>(vol *<span style="color: #268bd2;">s3fsVolume</span>) <span style="color: #268bd2;">string</span> {
        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">use default if empty</span>
        <span style="color: #859900;">if</span> cs.workingMountDir == <span style="color: #2aa198;">""</span> {
                cs.workingMountDir = <span style="color: #2aa198;">"/tmp"</span>
        }
        <span style="color: #859900;">return</span> filepath.<span style="color: #b58900;">Join</span>(cs.workingMountDir, vol.subDir)
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Get internal path where the volume is created</span>
<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">The reason why the internal path is "workingDir/subDir/subDir" is because:</span>
<span style="color: #93a1a1; font-style: italic;">//   </span><span style="color: #93a1a1; font-style: italic;">* the semantic is actually "workingDir/volId/subDir" and volId == subDir.</span>
<span style="color: #93a1a1; font-style: italic;">//   </span><span style="color: #93a1a1; font-style: italic;">* we need a mount directory per volId because you can have multiple</span>
<span style="color: #93a1a1; font-style: italic;">//     </span><span style="color: #93a1a1; font-style: italic;">CreateVolume calls in parallel and they may use the same underlying share.</span>
<span style="color: #93a1a1; font-style: italic;">//     </span><span style="color: #93a1a1; font-style: italic;">Instead of refcounting how many CreateVolume calls are using the same</span>
<span style="color: #93a1a1; font-style: italic;">//     </span><span style="color: #93a1a1; font-style: italic;">share, it's simpler to just do a mount per request.</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">getInternalVolumePath</span>(vol *<span style="color: #268bd2;">s3fsVolume</span>) <span style="color: #268bd2;">string</span> {
        <span style="color: #859900;">return</span> filepath.<span style="color: #b58900;">Join</span>(cs.<span style="color: #b58900;">getInternalMountPath</span>(vol), vol.subDir)
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Get user-visible share path for the volume</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">getVolumeSharePath</span>(vol *<span style="color: #268bd2;">s3fsVolume</span>) <span style="color: #268bd2;">string</span> {
        <span style="color: #859900;">return</span> filepath.<span style="color: #b58900;">Join</span>(<span style="color: #b58900;">string</span>(filepath.Separator), vol.baseDir, vol.subDir)
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Convert into s3fsVolume into a csi.Volume</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">s3fsVolToCSI</span>(vol *<span style="color: #268bd2;">s3fsVolume</span>, reqCapacity <span style="color: #268bd2;">int64</span>) *<span style="color: #268bd2;">csi.Volume</span> {
        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">Volume</span>{
                <span style="color: #268bd2;">CapacityBytes</span>: reqCapacity,
                <span style="color: #268bd2;">VolumeId</span>:      vol.id,
                <span style="color: #268bd2;">VolumeContext</span>: <span style="color: #859900;">map</span>[<span style="color: #268bd2;">string</span>]<span style="color: #268bd2;">string</span>{
                        <span style="color: #268bd2;">paramServer</span>: vol.server,
                        <span style="color: #268bd2;">paramShare</span>:  cs.<span style="color: #b58900;">getVolumeSharePath</span>(vol),
                        <span style="color: #268bd2;">paramBucket</span>: vol.bucket,
                },
        }
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Given a s3fsVolume, return a CSI volume id</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">getVolumeIDFromS3fsVol</span>(vol *<span style="color: #268bd2;">s3fsVolume</span>) <span style="color: #268bd2;">string</span> {
        idElements := <span style="color: #6c71c4;">make</span>([]<span style="color: #268bd2;">string</span>, totalIDElements)
        idElements[idServer] = strings.<span style="color: #b58900;">Trim</span>(vol.server, <span style="color: #2aa198;">"/"</span>)
        idElements[idBucket] = strings.<span style="color: #b58900;">Trim</span>(vol.bucket, <span style="color: #2aa198;">"/"</span>)
        idElements[idBaseDir] = strings.<span style="color: #b58900;">Trim</span>(vol.baseDir, <span style="color: #2aa198;">"/"</span>)
        idElements[idSubDir] = strings.<span style="color: #b58900;">Trim</span>(vol.subDir, <span style="color: #2aa198;">"/"</span>)
        <span style="color: #859900;">return</span> strings.<span style="color: #b58900;">Join</span>(idElements, <span style="color: #2aa198;">"/"</span>)
}

<span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">Given a CSI volume id, return a s3fsVolume</span>
<span style="color: #859900;">func</span> (cs *<span style="color: #268bd2;">ControllerServer</span>) <span style="color: #b58900;">getS3fsVolFromID</span>(id <span style="color: #268bd2;">string</span>) (*<span style="color: #268bd2;">s3fsVolume</span>, <span style="color: #268bd2;">error</span>) {
        tokens := strings.<span style="color: #b58900;">Split</span>(id, <span style="color: #2aa198;">"/"</span>)
        <span style="color: #859900;">if</span> <span style="color: #6c71c4;">len</span>(tokens) != totalIDElements {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, fmt.<span style="color: #b58900;">Errorf</span>(<span style="color: #2aa198;">"volume id %q unexpected format: got %v token(s) instead of %v"</span>, id, <span style="color: #6c71c4;">len</span>(tokens), totalIDElements)
        }

        <span style="color: #859900;">return</span> &amp;<span style="color: #268bd2;">s3fsVolume</span>{
                <span style="color: #268bd2;">id</span>:      id,
                <span style="color: #268bd2;">server</span>:  tokens[idServer],
                <span style="color: #268bd2;">bucket</span>:  tokens[idBucket],
                <span style="color: #268bd2;">baseDir</span>: tokens[idBaseDir],
                <span style="color: #268bd2;">subDir</span>:  tokens[idSubDir],
        }, <span style="color: #268bd2;">nil</span>
}
</pre>
</div>

<p>
mount 的过程是接收参数，将 s3fs 的 bucket 和 rgw_url 传入，构造 NodePublishVolume 请求交给 nodesever 去处理。
</p>
</div>
</div>


<div id="outline-container-org529eb16" class="outline-3">
<h3 id="org529eb16"><span class="section-number-3">3.3</span> 创建 nodeserver</h3>
<div class="outline-text-3" id="text-3-3">
<p>
nodeserver 顾名思义会跑在每个节点上，它跟 sidecar 容器 node-driver-registrar 一起工作，主要功能是接收 kubelet 的调用，实现存储卷的挂载和卸载，产生 volume 供这个节点上的 Pod 去消费。kubelet 跟 nodeserver 之间的通信是通过一个 Unix domain socket。
</p>

<p>
nodeserver 需要实现的接口如下：
</p>
<div class="org-src-container">
<pre class="src src-go">service Node {
  rpc <span style="color: #b58900;">NodeStageVolume</span> (NodeStageVolumeRequest)
    <span style="color: #b58900;">returns</span> (NodeStageVolumeResponse) {}
  rpc <span style="color: #b58900;">NodeUnstageVolume</span> (NodeUnstageVolumeRequest)
    <span style="color: #b58900;">returns</span> (NodeUnstageVolumeResponse) {}
  rpc <span style="color: #b58900;">NodePublishVolume</span> (NodePublishVolumeRequest)
    <span style="color: #b58900;">returns</span> (NodePublishVolumeResponse) {}
  rpc <span style="color: #b58900;">NodeUnpublishVolume</span> (NodeUnpublishVolumeRequest)
    <span style="color: #b58900;">returns</span> (NodeUnpublishVolumeResponse) {}
  rpc <span style="color: #b58900;">NodeGetVolumeStats</span> (NodeGetVolumeStatsRequest)
    <span style="color: #b58900;">returns</span> (NodeGetVolumeStatsResponse) {}
  rpc <span style="color: #b58900;">NodeExpandVolume</span>(NodeExpandVolumeRequest)
    <span style="color: #b58900;">returns</span> (NodeExpandVolumeResponse) {}
  rpc <span style="color: #b58900;">NodeGetCapabilities</span> (NodeGetCapabilitiesRequest)
    <span style="color: #b58900;">returns</span> (NodeGetCapabilitiesResponse) {}
  rpc <span style="color: #b58900;">NodeGetInfo</span> (NodeGetInfoRequest)
    <span style="color: #b58900;">returns</span> (NodeGetInfoResponse) {}
}
</pre>
</div>

<ul class="org-ul">
<li>stage/unstage: 检查 volume 是否 ready，可以在这个函数中检查 volume_id，target_path 之类的输入参数是否正确</li>
<li>publish/unpublish: 挂载、卸载 volume</li>
</ul>

<p>
s3fs 的 nodeserver 实现如下：
</p>

<p>
nodeserver.go
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #859900;">package</span> s3fs

<span style="color: #859900;">import</span> (
        <span style="color: #2aa198;">"fmt"</span>
        <span style="color: #2aa198;">"os"</span>
        <span style="color: #2aa198;">"strings"</span>

        <span style="color: #2aa198;">"github.com/golang/glog"</span>

        <span style="color: #2aa198;">"github.com/container-storage-interface/spec/lib/go/csi"</span>
        <span style="color: #2aa198;">"golang.org/x/net/context"</span>
        <span style="color: #2aa198;">"google.golang.org/grpc/codes"</span>
        <span style="color: #2aa198;">"google.golang.org/grpc/status"</span>
        <span style="color: #2aa198;">"k8s.io/utils/mount"</span>
)

<span style="color: #859900;">type</span> <span style="color: #268bd2;">NodeServer</span> <span style="color: #859900;">struct</span> {
        Driver  *Driver
        mounter mount.Interface
}

<span style="color: #859900;">func</span> (ns *<span style="color: #268bd2;">NodeServer</span>) <span style="color: #b58900;">NodePublishVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.NodePublishVolumeRequest</span>) (*<span style="color: #268bd2;">csi.NodePublishVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {

        <span style="color: #859900;">if</span> req.<span style="color: #b58900;">GetVolumeCapability</span>() == <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"Volume capability missing in request"</span>)
        }
        <span style="color: #859900;">if</span> <span style="color: #6c71c4;">len</span>(req.<span style="color: #b58900;">GetVolumeId</span>()) == 0 {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"Volume ID missing in request"</span>)
        }

        targetPath := req.<span style="color: #b58900;">GetTargetPath</span>()
        <span style="color: #859900;">if</span> <span style="color: #6c71c4;">len</span>(targetPath) == 0 {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"Target path not provided"</span>)
        }

        <span style="color: #859900;">var</span> err error
        notMnt, err := ns.mounter.<span style="color: #b58900;">IsLikelyNotMountPoint</span>(targetPath)
        <span style="color: #859900;">if</span> err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">if</span> os.<span style="color: #b58900;">IsNotExist</span>(err) {
                        <span style="color: #859900;">if</span> err := os.<span style="color: #b58900;">MkdirAll</span>(targetPath, 0750); err != <span style="color: #268bd2;">nil</span> {
                                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Internal, err.<span style="color: #b58900;">Error</span>())
                        }
                        notMnt = <span style="color: #268bd2;">true</span>
                } <span style="color: #859900;">else</span> {
                        glog.<span style="color: #b58900;">V</span>(4).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"[debug] error: %v"</span>, err.<span style="color: #b58900;">Error</span>())
                        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Internal, err.<span style="color: #b58900;">Error</span>())
                }
        }

        <span style="color: #859900;">if</span> !notMnt {
                <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">NodePublishVolumeResponse</span>{}, <span style="color: #268bd2;">nil</span>
        }

        mo := req.<span style="color: #b58900;">GetVolumeCapability</span>().<span style="color: #b58900;">GetMount</span>().<span style="color: #b58900;">GetMountFlags</span>()
        <span style="color: #859900;">if</span> req.<span style="color: #b58900;">GetReadonly</span>() {
                mo = <span style="color: #6c71c4;">append</span>(mo, <span style="color: #2aa198;">"ro"</span>)
        }

        s := req.<span style="color: #b58900;">GetVolumeContext</span>()[paramServer]
        bucket := req.<span style="color: #b58900;">GetVolumeContext</span>()[paramBucket]
        source := fmt.<span style="color: #b58900;">Sprintf</span>(<span style="color: #2aa198;">"%s;%s"</span>, s, bucket)

        <span style="color: #93a1a1; font-style: italic;">// </span><span style="color: #93a1a1; font-style: italic;">mount &#30340;&#26102;&#20505;&#20256;&#20837;&#21442;&#25968;&#36827;&#21435;</span>
        glog.<span style="color: #b58900;">V</span>(4).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"[debug] source: %v, targetPath: %v, mo: %v"</span>, source, targetPath, mo)
        err = ns.mounter.<span style="color: #b58900;">Mount</span>(source, targetPath, <span style="color: #2aa198;">"s3fs"</span>, mo)
        <span style="color: #859900;">if</span> err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">if</span> os.<span style="color: #b58900;">IsPermission</span>(err) {
                        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.PermissionDenied, err.<span style="color: #b58900;">Error</span>())
                }
                <span style="color: #859900;">if</span> strings.<span style="color: #b58900;">Contains</span>(err.<span style="color: #b58900;">Error</span>(), <span style="color: #2aa198;">"invalid argument"</span>) {
                        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, err.<span style="color: #b58900;">Error</span>())
                }
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Internal, err.<span style="color: #b58900;">Error</span>())
        }

        <span style="color: #859900;">if</span> ns.Driver.perm != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">if</span> err := os.<span style="color: #b58900;">Chmod</span>(targetPath, os.<span style="color: #b58900;">FileMode</span>(*ns.Driver.perm)); err != <span style="color: #268bd2;">nil</span> {
                        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Internal, err.<span style="color: #b58900;">Error</span>())
                }
        }

        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">NodePublishVolumeResponse</span>{}, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (ns *<span style="color: #268bd2;">NodeServer</span>) <span style="color: #b58900;">NodeUnpublishVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.NodeUnpublishVolumeRequest</span>) (*<span style="color: #268bd2;">csi.NodeUnpublishVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">if</span> <span style="color: #6c71c4;">len</span>(req.<span style="color: #b58900;">GetVolumeId</span>()) == 0 {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"Volume ID missing in request"</span>)
        }
        <span style="color: #859900;">if</span> <span style="color: #6c71c4;">len</span>(req.<span style="color: #b58900;">GetTargetPath</span>()) == 0 {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.InvalidArgument, <span style="color: #2aa198;">"Target path missing in request"</span>)
        }

        targetPath := req.<span style="color: #b58900;">GetTargetPath</span>()
        notMnt, err := ns.mounter.<span style="color: #b58900;">IsLikelyNotMountPoint</span>(targetPath)

        <span style="color: #859900;">if</span> err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">if</span> os.<span style="color: #b58900;">IsNotExist</span>(err) {
                        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.NotFound, <span style="color: #2aa198;">"Targetpath not found"</span>)
                }
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Internal, err.<span style="color: #b58900;">Error</span>())
        }
        <span style="color: #859900;">if</span> notMnt {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.NotFound, <span style="color: #2aa198;">"Volume not mounted"</span>)
        }

        err = mount.<span style="color: #b58900;">CleanupMountPoint</span>(req.<span style="color: #b58900;">GetTargetPath</span>(), ns.mounter, <span style="color: #268bd2;">false</span>)
        <span style="color: #859900;">if</span> err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Internal, err.<span style="color: #b58900;">Error</span>())
        }

        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">NodeUnpublishVolumeResponse</span>{}, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (ns *<span style="color: #268bd2;">NodeServer</span>) <span style="color: #b58900;">NodeGetInfo</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.NodeGetInfoRequest</span>) (*<span style="color: #268bd2;">csi.NodeGetInfoResponse</span>, <span style="color: #268bd2;">error</span>) {
        glog.<span style="color: #b58900;">V</span>(5).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"Using default NodeGetInfo"</span>)

        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">NodeGetInfoResponse</span>{
                <span style="color: #268bd2;">NodeId</span>: ns.Driver.nodeID,
        }, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (ns *<span style="color: #268bd2;">NodeServer</span>) <span style="color: #b58900;">NodeGetCapabilities</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.NodeGetCapabilitiesRequest</span>) (*<span style="color: #268bd2;">csi.NodeGetCapabilitiesResponse</span>, <span style="color: #268bd2;">error</span>) {
        glog.<span style="color: #b58900;">V</span>(5).<span style="color: #b58900;">Infof</span>(<span style="color: #2aa198;">"Using default NodeGetCapabilities"</span>)

        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">NodeGetCapabilitiesResponse</span>{
                <span style="color: #268bd2;">Capabilities</span>: []*<span style="color: #268bd2;">csi.NodeServiceCapability</span>{
                        {
                                <span style="color: #268bd2;">Type</span>: &amp;csi.<span style="color: #268bd2;">NodeServiceCapability_Rpc</span>{
                                        <span style="color: #268bd2;">Rpc</span>: &amp;csi.<span style="color: #268bd2;">NodeServiceCapability_RPC</span>{
                                                <span style="color: #268bd2;">Type</span>: csi.NodeServiceCapability_RPC_UNKNOWN,
                                        },
                                },
                        },
                },
        }, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (ns *<span style="color: #268bd2;">NodeServer</span>) <span style="color: #b58900;">NodeGetVolumeStats</span>(ctx <span style="color: #268bd2;">context.Context</span>, in *<span style="color: #268bd2;">csi.NodeGetVolumeStatsRequest</span>) (*<span style="color: #268bd2;">csi.NodeGetVolumeStatsResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> (ns *<span style="color: #268bd2;">NodeServer</span>) <span style="color: #b58900;">NodeUnstageVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.NodeUnstageVolumeRequest</span>) (*<span style="color: #268bd2;">csi.NodeUnstageVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">NodeUnstageVolumeResponse</span>{}, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (ns *<span style="color: #268bd2;">NodeServer</span>) <span style="color: #b58900;">NodeStageVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.NodeStageVolumeRequest</span>) (*<span style="color: #268bd2;">csi.NodeStageVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> &amp;csi.<span style="color: #268bd2;">NodeStageVolumeResponse</span>{}, <span style="color: #268bd2;">nil</span>
}

<span style="color: #859900;">func</span> (ns *<span style="color: #268bd2;">NodeServer</span>) <span style="color: #b58900;">NodeExpandVolume</span>(ctx <span style="color: #268bd2;">context.Context</span>, req *<span style="color: #268bd2;">csi.NodeExpandVolumeRequest</span>) (*<span style="color: #268bd2;">csi.NodeExpandVolumeResponse</span>, <span style="color: #268bd2;">error</span>) {
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>, status.<span style="color: #b58900;">Error</span>(codes.Unimplemented, <span style="color: #2aa198;">""</span>)
}

<span style="color: #859900;">func</span> <span style="color: #b58900;">makeDir</span>(pathname <span style="color: #268bd2;">string</span>) <span style="color: #268bd2;">error</span> {
        err := os.<span style="color: #b58900;">MkdirAll</span>(pathname, os.<span style="color: #b58900;">FileMode</span>(0755))
        <span style="color: #859900;">if</span> err != <span style="color: #268bd2;">nil</span> {
                <span style="color: #859900;">if</span> !os.<span style="color: #b58900;">IsExist</span>(err) {
                        <span style="color: #859900;">return</span> err
                }
        }
        <span style="color: #859900;">return</span> <span style="color: #268bd2;">nil</span>
}

</pre>
</div>
</div>
</div>
</div>










<div id="outline-container-orga7c6282" class="outline-2">
<h2 id="orga7c6282"><span class="section-number-2">4</span> 参考资料</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li><a href="https://kubernetes-csi.github.io/docs/introduction.html">https://kubernetes-csi.github.io/docs/introduction.html</a></li>
<li><a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">https://github.com/container-storage-interface/spec/blob/master/spec.md</a></li>
</ul>
</div>
</div>

    </article>
  </body>
</html>
